---
title: "Template to make PSRC leaflet map"
author: "suzanne"
date: "2023-05-05"
output: html_document
---
# How to quickly make a formatted map
This template shows you how to make a map given a numeric or categorical data item with a geographic id and a shape file with the same ID.


**Inputs required: **
a data table with a field to map and an ID, 
a geographic layer with a matching ID

**User options:**
Map title, Map subtitle,
Legend tile, Legend subtitle
psrccolors


### 1. Read in mapping and helper libraries

```{r }
library(sf) # geographic data library
library(dplyr) # for working with data frames
library(psrcelmer) # to get data from Elmer
library(psrcplot) # to get color schemes
library(htmltools)
library(htmlwidgets)
library(mapview)
```


### 2. Read in any other libraries or keys you need

```{r}
library(psrccensus)


Sys.getenv("CENSUS_API_KEY")
```


### 3. Define create_psrc_map function





creating starting point, middle point, end point colors

This R file has a function called create_psrc_map to create a leaflet map for you
```{r}
source('map_region.R')
```

# Read in Data Table with a geographic field ID
Prepare data to join with the geographic layer
Note: you will need field names to match on


### Get the data with numeric or categorical field and geographic id
This example gets ACS 5-year data for Asian Groups by Tract.
```{r, echo=FALSE}
big_tbl <-psrccensus::get_acs_recs(geography='tract',table.names='B02015',year=2021, acs.type='acs5')
```

### Clean up the data to join to the geographic layer
```{r, echo=FALSE}
# read in data table and process data to join and map
tbl <- big_tbl %>%filter(label=='Estimate!!Total:!!Chinese, except Taiwanese')%>% 
  dplyr::select(GEOID,estimate) %>%
  dplyr::mutate(dplyr::across(c('GEOID'), as.character))%>%
  dplyr::group_by(GEOID) %>%
  dplyr::summarise(Total=sum(estimate))
```


##Read ElmerGeo geographic layer

```{r, echo=FALSE}
tract_layer_name <- "TRACT2020_NOWATER"

lyr <- st_read_elmergeo(tract_layer_name)
```

Join to data table layer via matching IDs, choose the field to map
```{r pressure, echo=FALSE}
lyr_data<- dplyr::left_join(lyr,tbl, by = c("geoid20"="GEOID"))
# this is the field to map
lyr_datafield<-lyr_data$Total
```


## Call the function to make the map
```{r}
psrc_purple_plus<-append(psrc_colors$purples_inc, "#FFFFFF", after=0)
map_it<-create_psrc_map(lyr=lyr_data, 
                        lyr_data_field=lyr_data_field,
                        legend_title= 'Chinese, except Taiwanese Population',
                        legend_subtitle = 'by Census Tract',
                        psrc_col_pal=psrc_purple_plus)

map_it
```

## Save the map as html
```{r}
mapshot(map_it, url= "Chinese, except TaiwanesePop.html")
```


## Save the map as png
```{r}
mapshot(map_it, file= "Chinese, except TaiwanesePop.png")

```

